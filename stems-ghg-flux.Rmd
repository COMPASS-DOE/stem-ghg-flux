---
title: "stem-ghg-flux"
author: "EP"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
theme_set(theme_minimal())
library(arrow)
library(readr)
library(tidyr)
```

# Science questions

1. How much do tree stem GHG fluxes vary over the course of the year?
2. ...

# Read data

```{r read-data}
# Data file from the TEMPEST repository
message("Reading data...")
dat <- read_parquet("tempest_tree_ghg_fluxes.parquet")

message(nrow(dat), " rows and ", ncol(dat), " columns")
```


# Soil data

```{r soil-data}
# Read soil temperature and moisture data
files <- list.files(path = "L2_data/", pattern = "parquet$", full.names = TRUE)
lapply(files, read_parquet) %>% 
  bind_rows() %>% 
  # compute a 'Date' column...
  mutate(Date = as.Date(TIMESTAMP)) %>% 
  # ...and average variables for each date
  group_by(Site, Plot, Date, research_name) %>% 
  summarise(Value = mean(Value), .groups = "drop") %>% 
  # reshape 
  pivot_wider(names_from = "research_name", values_from = "Value", names_repair = "universal") ->
  soildat

# TODO: plot soil data
```


# Quick summary and visualization of data

```{r quick-look}
glimpse(dat)

# 1. Print summary
summary(dat)
# 2. ggplot(dat, ...)

```

# Join with species data

```{r sapflow-trees}
# 3. Drop existing species column from dat
# 4. Read in TEMPEST_Trees_Instruments.csv

tree_inventory <- read.csv("TEMPEST_Trees_Instruments.csv") %>% 
  select(Sapflux_ID, spp) # don't need these

#
dat %>%
  left_join(tree_inventory,
            # in dat the column is "ID", while in the tree inventory it's
            # "Sapflux_ID", so we tell left_join that these two columns 
            # correspond to each other 
            by = c("ID" = "Sapflux_ID"), 
            # this is optional but good 'defensive programming': we specify
            # that we expect a many-to-one relationship (i.e., there shouldn't
            # be multiple matches for a given sapflux tree!)
            relationship = "many-to-one") ->
        tree_dat

# To help readability, generate the common name from the species code
tree_dat %>%
  mutate(Species = case_when(
    spp == "ACRU" ~ "Red maple",
    spp == "LITU" ~ "Tulip poplar",
    spp == "FAGR" ~ "American beech"
  )) -> 
  tree_dat

# Make a nice summary table to check things
tree_dat %>% 
  # for each plot and species...
  group_by(Plot, Species) %>% 
  # ...count the number of distinct IDs...
  summarise(value = n_distinct(ID), .groups = "drop") %>% 
  # ...and then reshape so that plot names run across the top
  pivot_wider(names_from = "Plot") %>% 
  knitr::kable()
```


# Plot annual cycle - raw data

```{r annual-cycle-raw}
# Filter out the TEMPEST flood measurements
tree_dat %>% 
  filter(Timepoint %in% c("(none)", "Pre-Treatment")) ->
  tree_dat_ac

message("Annual cycle dataset has ", nrow(tree_dat_ac), " rows and ",
        ncol(tree_dat_ac), " columns")

# EVAN:
# 1. What data frame do we want to use to plot?
# 2. This plots each tree as a separate color. How useful is this? What are alternatives?
ggplot(data = tree_dat, 
       mapping = aes(x = Date, y = CO2_lin_flux.estimate, color = Species))+
  geom_point() + # Add a layer of points
  labs(title = "Practice")  # Add labels and a title
```

# Summarize by ...?

The trees are _experimental units_ but what we're actually interested in is...

```{r annual-cycle-summary}

# EVAN: how do we want to summarize and then plot the annual cycle data?

library(dplyr)
library(lubridate)

#calculate average CO2 flux per year per species

tree_dat %>%
  mutate(Year = year(Date)) %>%  # Extract the year from the Date column
  group_by(Year, Species) %>%  # Group by Year and Species
  summarise(avg_CO2_flux = mean(CO2_lin_flux.estimate, na.rm = TRUE), .groups = "drop") -> 
  avg_CO2flux_per_year_species

# View the resulting table
print(avg_CO2flux_per_year_species)

# Plotting the average CO2 flux by year and species

ggplot(avg_CO2flux_per_year_species, aes(x = Year, y = avg_CO2_flux, color = Species)) +
  geom_line(size = 1) +  # Add lines to connect points
  geom_point(size = 3) +  # Add points at each data point
  labs(
    title = "Average Annual CO2 Flux by Species", 
    x = "Year", 
    y = "Average CO2 Flux (g CO2 / m² / day)",
    color = "Species"
  ) +
  theme_minimal() +  # Clean minimal theme
  theme(
    legend.position = "top",  # Position the legend at the top
    axis.text.x = element_text(angle = 45, hjust = 1)  # Angle x-axis labels for better readability
  )



#calculate average CH4 flux per year per species

tree_dat %>%
  mutate(Year = year(Date)) %>%  # Extract the year from the Date column
  group_by(Year, Species) %>%  # Group by Year and Species
  summarise(avg_CH4_flux = mean(CH4_lin_flux.estimate, na.rm = TRUE), .groups = "drop") -> 
  avg_CH4flux_per_year_species

# View the resulting table
print(avg_CH4flux_per_year_species)

# Plotting the average CH4 flux by year and species
ggplot(avg_CH4flux_per_year_species, aes(x = Year, y = avg_CH4_flux, color = Species)) +
  geom_line(size = 1) +  # Add lines to connect points
  geom_point(size = 3) +  # Add points at each data point
  labs(
    title = "Average Annual CH4 Flux by Species", 
    x = "Year", 
    y = "Average CO2 Flux (g CH4 / m² / day)",
    color = "Species"
  ) +
  theme_minimal() +  # Clean minimal theme
  theme(
    legend.position = "top",  # Position the legend at the top
    axis.text.x = element_text(angle = 45, hjust = 1)  # Angle x-axis labels for better readability
  )
```
# Change "Seawater" to "Saltwater"

```{}

tree_dat <- tree_dat %>%
  mutate(Plot = recode(Plot, "Seawater" = "Saltwater"))

```

# Looking at average CO2 and CH4 by date instead of year

```{}
#calculate average CO2 flux per date per species

# Summarizing by specific Date and Species
avg_CO2flux_per_day_species <- tree_dat %>%
  group_by(Date, Species) %>%  # Group by full Date and Species
  summarise(avg_CO2_flux = mean(CO2_lin_flux.estimate, na.rm = TRUE), .groups = "drop")

# Ensure the Date column is in Date format (if needed)
avg_CO2flux_per_day_species$Date <- as.Date(avg_CO2flux_per_day_species$Date)


# Plotting the average flux by Date and Species
ggplot(avg_CO2flux_per_day_species, aes(x = Date, y = avg_CO2_flux, color = Species)) +
  geom_line(size = 1) +  # Add lines to connect points
  geom_point(size = 3) +  # Add points at each data point
  labs(
    title = "Average CO2 Flux by Date and Species", 
    x = "Date", 
    y = "Average CO2 Flux (g CO2 / m² / day)",
    color = "Species"
  ) +
  theme_minimal() +  # Clean minimal theme
  theme(
    legend.position = "top",  # Position the legend at the top
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels for readability
  )


  #calculate average CH4 flux per date per species

# Summarizing by specific Date and Species
avg_CH4flux_per_day_species <- tree_dat %>%
  group_by(Date, Species) %>%  # Group by full Date and Species
  summarise(avg_CH4_flux = mean(CH4_lin_flux.estimate, na.rm = TRUE), .groups = "drop")

# Ensure the Date column is in Date format (if needed)
avg_CH4flux_per_day_species$Date <- as.Date(avg_CH4flux_per_day_species$Date)


# Plotting the average CH4 flux by Date and Species
ggplot(avg_CH4flux_per_day_species, aes(x = Date, y = avg_CH4_flux, color = Species)) +
  geom_line(size = 1) +  # Add lines to connect points
  geom_point(size = 3) +  # Add points at each data point
  labs(
    title = "Average CH4 Flux by Date and Species", 
    x = "Date", 
    y = "Average CH4 Flux (g CO2 / m² / day)",
    color = "Species"
  ) +
  theme_minimal() +  # Clean minimal theme
  theme(
    legend.position = "top",  # Position the legend at the top
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels for readability
  )
```

#remove s7
  
```{r no S7}
# Specify the tree ID you want to remove (S7)
tree_id_to_remove <- "S7"

# Create a new dataset excluding the specified tree ID (S7)
tree_dat_no_S7 <- tree_dat %>%
  filter(ID != tree_id_to_remove)  # Exclude the tree with ID = "S7"

# Check column names to ensure 'ID' is correct
colnames(tree_dat)

# Specify the tree ID you want to remove (S7)
tree_id_to_remove <- "S7"

# Calculate the average CH4 flux per date and species excluding tree "S7"
avg_CH4flux_no_S7 <- tree_dat_no_S7 %>%
  group_by(Date, Species) %>%  # Group by Date and Species
  summarise(avg_CH4_flux = mean(CH4_lin_flux.estimate, na.rm = TRUE), .groups = "drop")

# Ensure the Date column is in Date format (if needed)
avg_CH4flux_no_S7$Date <- as.Date(avg_CH4flux_no_S7$Date)

# Plotting the average CH4 flux by Date and Species (excluding tree "S7")
ggplot(avg_CH4flux_no_S7, aes(x = Date, y = avg_CH4_flux, color = Species)) +
  geom_line(size = 1) +  # Add lines to connect points
  geom_point(size = 3) +  # Add points at each data point
  labs(
    title = "Average CH4 Flux by Year and Species (Excluding Tree S7)", 
    x = "Date", 
    y = "Average CH4 Flux (g CH4 / m² / day)",
    color = "Species"
  ) +
  theme_minimal() +  # Clean minimal theme
  theme(
    legend.position = "top",  # Position the legend at the top
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels for readability
  )

```

#Add error bars and remove 2021 for CH4 data

```{r}
avg_CH4flux_stats_filtered <- tree_dat %>%
  filter(ID != "S7") %>%             # remove tree S7
  mutate(Year = year(Date)) %>%      # extract year
  filter(Year != 2021) %>%           # exclude 2021
  group_by(Year, Species) %>%        # group by Year for annual average
  summarise(
    avg_CH4_flux = mean(CH4_lin_flux.estimate, na.rm = TRUE),
    sd_CH4_flux  = sd(CH4_lin_flux.estimate, na.rm = TRUE),
    .groups = "drop"
  )

# Plot using the filtered dataset
ggplot(avg_CH4flux_stats_filtered, aes(x = Year, y = avg_CH4_flux, color = Species)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  geom_errorbar(aes(
    ymin = avg_CH4_flux - sd_CH4_flux,
    ymax = avg_CH4_flux + sd_CH4_flux
  ), width = 0.2) +
  labs(
    title = "Average Annual CH4 Flux by Species (Excluding Tree S7 and 2021)",
    x = "Year",
    y = "Average CH4 Flux (g CH4 / m² / day)",
    color = "Species"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```


# Incorporate Plots (SW, FW, Control) into figures

```{r}

avg_CH4flux_stats_filtered <- tree_dat %>%
  filter(ID != "S7") %>%
  mutate(Year = lubridate::year(Date)) %>%
  filter(Year != 2021) %>%
  group_by(Year, Species, Plot) %>%   # <- include Plot here
  summarise(
    avg_CH4_flux = mean(CH4_lin_flux.estimate, na.rm = TRUE),
    sd_CH4_flux = sd(CH4_lin_flux.estimate, na.rm = TRUE),
    .groups = "drop"
  )
  
  ggplot(avg_CH4flux_stats_filtered,
       aes(x = Year, y = avg_CH4_flux, color = Species)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(
    ymin = avg_CH4_flux - sd_CH4_flux,
    ymax = avg_CH4_flux + sd_CH4_flux
  ), width = 0.2) +
  facet_wrap(~ Plot) +   # <- split panels by plot
  theme_minimal()

```

#Incorporate soildat into CH4 data

```{r}

tree_soil_dat <- tree_dat %>%
  mutate(
    Date = as.Date(Date),
    Plot = recode(Plot, "C" = "Control", "F" = "Freshwater", "S" = "Seawater")
  ) %>%
  left_join(
    soildat %>%
      mutate(Date = as.Date(Date)) %>%
      group_by(Plot, Date) %>%
      summarise(soil.temp.5cm = mean(soil.temp.5cm, na.rm = TRUE), .groups = "drop"),
    by = c("Plot", "Date"),
    relationship = "many-to-one"
  )
  

  
  # Ensure Date class matches
tree_dat$Date <- as.Date(tree_dat$Date)
soildat$Date <- as.Date(soildat$Date)

# Optional: recode plots to full names
tree_dat <- tree_dat %>%
  mutate(Plot = recode(Plot, "C" = "Control", "F" = "Freshwater", "S" = "Seawater"))

soildat <- soildat %>%
  mutate(Plot = recode(Plot, "C" = "Control", "F" = "Freshwater", "S" = "Seawater"))

# Join soil temperature
tree_soil_dat <- tree_dat %>%
  left_join(
    soildat %>%
      group_by(Plot, Date) %>%
      summarise(soil.temp.5cm = mean(soil.temp.5cm, na.rm = TRUE), .groups = "drop"),
    by = c("Plot", "Date")
  )

# Check for unmatched rows
summary(tree_soil_dat$soil.temp.5cm)
  
  # Prepare data for plotting
tree_soil_plot <- tree_soil_dat %>%
  filter(
    !is.na(soil.temp.5cm),
    !is.nan(soil.temp.5cm),
    !is.na(CH4_lin_flux.estimate),
    !is.nan(CH4_lin_flux.estimate)
    )
    
  ggplot(tree_soil_plot,
       aes(x = soil.temp.5cm, y = CH4_lin_flux.estimate, color = Species)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE) +
  facet_wrap(~ Plot) +
  theme_minimal()
  
  
```

#No S7

```{r}

# Prepare the dataset excluding tree S7
tree_soil_plot_no_S7 <- tree_dat %>%
  filter(ID != "S7") %>%                              # remove tree S7
  mutate(
    Date = as.Date(Date),
    Plot = recode(Plot, "C" = "Control", "F" = "Freshwater", "S" = "Seawater")
  ) %>%
  left_join(
    soildat %>%
      mutate(Date = as.Date(Date)) %>%
      group_by(Plot, Date) %>%
      summarise(soil.temp.5cm = mean(soil.temp.5cm, na.rm = TRUE), .groups = "drop"),
    by = c("Plot", "Date"),
    relationship = "many-to-one"
  ) %>%
  filter(
    !is.na(soil.temp.5cm),
    !is.nan(soil.temp.5cm),
    !is.na(CH4_lin_flux.estimate),
    !is.nan(CH4_lin_flux.estimate)
  )

# Plot using the new dataset

ggplot(tree_soil_plot_no_S7,
       aes(x = soil.temp.5cm, y = CH4_lin_flux.estimate, color = Species)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE) +
  facet_wrap(~ Plot) +
  theme_minimal()

```

# Doing the same for CO2

```{r}

# Prepare the dataset including S7 for CO2
tree_soil_plot_CO2 <- tree_dat %>%
  mutate(
    Date = as.Date(Date),
    Plot = recode(Plot, "C" = "Control", "F" = "Freshwater", "S" = "Seawater")
  ) %>%
  left_join(
    soildat %>%
      mutate(Date = as.Date(Date)) %>%
      group_by(Plot, Date) %>%
      summarise(soil.temp.5cm = mean(soil.temp.5cm, na.rm = TRUE), .groups = "drop"),
    by = c("Plot", "Date"),
    relationship = "many-to-one"
  ) %>%
  filter(
    !is.na(soil.temp.5cm),
    !is.nan(soil.temp.5cm),
    !is.na(CO2_lin_flux.estimate),
    !is.nan(CO2_lin_flux.estimate)
  )

# Plot using the new dataset
ggplot(tree_soil_plot_CO2,
       aes(x = soil.temp.5cm, y = CO2_lin_flux.estimate, color = Species)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE) +
  facet_wrap(~ Plot) +
  theme_minimal() +
  labs(
    x = "Soil Temperature (5 cm, °C)",
    y = "CO2 Flux (g CO2 / m² / day)",
    title = "CO2 Flux vs Soil Temperature by Plot (Including Tree S7)"
  )
  
```
  